@page "/"
@rendermode InteractiveServer
@using instech_blazor_coding_task.Models
@using instech_blazor_coding_task.Services
@using System.Text.Json;
@inject IDragService DragService
@inject IPositionService PositionService
@inject IVesselLayoutService VesselLayoutService
@inject IRotationService RotationService
@inject IApiService ApiService

<PageTitle>Bin packing problem</PageTitle>

@* The OnDragMove method updates the position of the element being dragged relative to the page.
Therefore the first element has to handle it. *@
<div @onmousemove="OnDragMove">
    <PageHeader OnTryAgainClick="GenerateNewVessels" />

    @if (Vessels == null)
    {
        <div>Loading...</div>
    }
    else
    {
        <div class="game-area">
            <AnchorageBox Width="anchorageWidth" Height="anchorageHeight" />
            
            @foreach (var vessel in Vessels)
            {
                <VesselItem 
                    Vessel="vessel" 
                    OnMouseDown="@(e => OnDragStart(vessel, e))"
                    OnMouseUp="@(e => OnDragEnd(Vessels))"
                    OnDoubleClick="@(e => OnVesselDoubleClick(vessel))" />
            }
        </div>

        <div class="instructions-card" style="width: @(anchorageWidth - 100)px;">
            <div class="instructions-title">Instructions</div>
            <ul class="instructions-list">
                <li class="instruction-item">
                    <span class="instruction-number">1</span>
                    <span class="instruction-text">Click and hold on any vessel (pink rectangles) on the right</span>
                </li>
                <li class="instruction-item">
                    <span class="instruction-number">2</span>
                    <span class="instruction-text">Drag the vessel into the blue anchorage zone</span>
                </li>
                <li class="instruction-item">
                    <span class="instruction-number">3</span>
                    <span class="instruction-text">Double-click on a vessel to rotate it 90 degrees</span>
                </li>
                <li class="instruction-item">
                    <span class="instruction-number">4</span>
                    <span class="instruction-text">Vessels cannot overlap with each other</span>
                </li>
                <li class="instruction-item">
                    <span class="instruction-number">5</span>
                    <span class="instruction-text">Place all vessels completely inside the anchorage to win</span>
                </li>
            </ul>
        </div>
        
        <SuccessMessage IsVisible="anchorageFull" />
    }
</div>

@code {
private double anchorageWidth = 500;

private double anchorageHeight = 500;

private List<Vessel>? Vessels = new List<Vessel>();

private bool anchorageFull = false;

private DateTime _lastRotationTime = DateTime.MinValue;
private const int RotationDebounceMs = 300;

    protected override async Task OnInitializedAsync()
    {
        await LoadVesselsFromApi();
    }

    private async Task LoadVesselsFromApi()
    {
        try
        {
            var response = await ApiService.GetRandomFleetAsync();

            if (response == null)
            {
                Console.WriteLine("Failed to fetch fleet data");
                return;
            }
            
            // Update anchorage dimensions from API
            if (response.anchorageSize != null)
            {
                anchorageHeight = response.anchorageSize.Height * 20;
                anchorageWidth = response.anchorageSize.Width * 20;
            }

            // Delegate vessel layout to the VesselLayoutService
            Vessels = VesselLayoutService.GenerateVesselLayout(response.fleets, anchorageWidth);
        }
        catch (Exception ex)
        {
            Console.WriteLine("Error loading vessels: " + ex.Message);
        }
    }

private void OnDragStart(Vessel vessel, MouseEventArgs e) {
    DragService.OnDragStart(vessel, e);
}

private void OnDragMove(MouseEventArgs e) {
    DragService.OnDragMove(e);
}

private void OnDragEnd(IEnumerable<Vessel> allVessels) {
    DragService.OnDragEnd(allVessels, PositionService);
    
    var anchorage = new Anchorage { Width = anchorageWidth, Height = anchorageHeight };
    anchorageFull = PositionService.AllVesselsInAnchorage(allVessels, anchorage);
}

private async Task GenerateNewVessels() {
    anchorageFull = false;
    Vessels = null;
    await LoadVesselsFromApi();
}

private void OnVesselDoubleClick(Vessel vessel) {
    // Prevent multiple rotations in a short time period
    var now = DateTime.Now;
    if ((now - _lastRotationTime).TotalMilliseconds < RotationDebounceMs)
    {
        return;
    }
    
    _lastRotationTime = now;
    RotationService.RotateVessel(vessel);
    StateHasChanged();
}
}